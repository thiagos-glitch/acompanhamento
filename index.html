<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volumetria | Acesso Restrito</title>
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- √çcones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PapaParse (Leitor de CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- =========================
         TELA DE LOGIN
    ========================== -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 fade-in text-center relative overflow-hidden">
            <!-- Detalhe decorativo -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-50 text-indigo-600 text-2xl shadow-sm">
                <i class="fa-solid fa-lock"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Acesso Restrito</h2>
            <p class="text-sm text-slate-500 mb-6">Digite suas credenciais para visualizar o dashboard de volumetria.</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Usu√°rio</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="username" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Seu usu√°rio" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Senha</label>
                    <div class="relative">
                        <i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="password" id="password" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Sua senha" required>
                    </div>
                </div>

                <div id="loginError" class="hidden text-red-500 text-xs text-center font-medium bg-red-50 p-2 rounded-lg border border-red-100">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> Usu√°rio ou senha incorretos.
                </div>

                <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition transform active:scale-95">
                    Entrar <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </form>
            
            <p class="mt-6 text-xs text-slate-400">Digital Growth &copy; 2025</p>
        </div>
    </div>

    <!-- =========================
         CONTE√öDO DO DASHBOARD (Escondido)
    ========================== -->
    <div id="appContent" class="hidden h-full flex flex-col">
        <!-- Navbar -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-20 shadow-sm flex-shrink-0">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-md shadow-indigo-200">
                        <i class="fa-solid fa-layer-group"></i>
                    </span>
                    Volumetria
                </h1>
                
                <!-- Seletor de M√™s -->
                <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition cursor-pointer">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span id="currentMonthDisplay" class="w-36 text-center font-semibold text-sm text-slate-700 select-none uppercase tracking-wide">
                        ...
                    </span>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition cursor-pointer">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="relative w-64 group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                    <input type="text" id="searchInput" onkeyup="renderDashboard()" placeholder="Filtrar cliente..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition">
                </div>
                
                <button onclick="openConfig()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium rounded-lg transition shadow-sm" title="Configurar Links">
                    <i class="fa-solid fa-gear"></i>
                </button>
                
                <!-- Logout -->
                <button onclick="logout()" class="p-2 text-slate-400 hover:text-red-500 transition" title="Sair">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>

                <div id="loadingIndicator" class="hidden">
                    <div class="loader"></div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 flex flex-col overflow-hidden p-6 gap-6">
            <!-- KPIs Row -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 flex-shrink-0">
                <!-- Social -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entregas Social</p>
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-slate-800" id="kpiSocialDone">0</h3>
                            <span class="text-sm text-slate-400 font-medium">/ <span id="kpiSocialMeta">0</span></span>
                        </div>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fa-brands fa-instagram"></i></div>
                </div>

                <!-- Perf -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entregas Perf.</p>
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-slate-800" id="kpiPerfDone">0</h3>
                            <span class="text-sm text-slate-400 font-medium">/ <span id="kpiPerfMeta">0</span></span>
                        </div>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center text-xl"><i class="fa-solid fa-chart-line"></i></div>
                </div>

                <!-- Risk -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between border-l-4 border-l-red-500 hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Clientes Cr√≠ticos</p>
                        <h3 class="text-3xl font-bold text-red-600" id="kpiRisk">0</h3>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
                </div>

                 <!-- Total -->
                 <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Clientes</p>
                        <h3 class="text-3xl font-bold text-slate-800" id="kpiTotalClients">0</h3>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-slate-50 text-slate-600 flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 overflow-hidden flex flex-col relative">
                <div class="overflow-auto custom-scroll flex-1">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 pl-6 bg-slate-50 sticky left-0 z-20 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-wider shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">Cliente</th>
                                <th class="p-2 border-b border-slate-200 text-center bg-blue-50/50 border-l border-slate-200" colspan="3"><span class="text-blue-700 font-bold text-xs"><i class="fa-brands fa-instagram mr-1"></i> Social Media</span></th>
                                <th class="p-2 border-b border-slate-200 text-center bg-purple-50/50 border-l border-slate-200" colspan="3"><span class="text-purple-700 font-bold text-xs"><i class="fa-solid fa-chart-line mr-1"></i> Performance</span></th>
                            </tr>
                            <tr class="text-[10px] uppercase text-slate-400 font-bold border-b border-slate-200 bg-slate-50">
                                <th class="sticky left-0 bg-slate-50 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]"></th>
                                <!-- Social -->
                                <th class="p-2 text-center w-20 border-l border-slate-100">Meta</th>
                                <th class="p-2 text-center w-32">Realizado</th>
                                <th class="p-2 text-center w-16">Gap</th>
                                <!-- Perf -->
                                <th class="p-2 text-center w-20 border-l border-slate-100">Meta</th>
                                <th class="p-2 text-center w-32">Realizado</th>
                                <th class="p-2 text-center w-16">Gap</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/80 z-0">
                    <div class="bg-slate-50 p-6 rounded-full mb-4">
                        <i class="fa-solid fa-database text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-lg font-medium text-slate-600">Sem dados para exibir</h3>
                    <p class="text-sm">Verifique a conex√£o ou mude o m√™s.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-800">Conectar Base de Dados</h3>
                <button onclick="closeConfig()" class="text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Link CSV de Cadastros (Metas)</label>
                    <input type="text" id="urlMetasInput" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Link CSV de Hist√≥rico (Log)</label>
                    <input type="text" id="urlLogInput" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeConfig()" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Cancelar</button>
                <button onclick="saveAndLoad()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-lg shadow-lg transition">Salvar</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // =================================================================
        // √ÅREA DE CONFIGURA√á√ÉO FIXA (Edite aqui para o Vercel)
        // =================================================================
        
        // Links CSV (Aba BD_Metas e Log_Robo)
        const LINK_FIXO_METAS = "https://docs.google.com/spreadsheets/d/1IrWfGQDcHoOK7RQBQBi-Ob1gJTnZ4FNPnMndJZZBFfg/export?format=csv&gid=0";
        const LINK_FIXO_LOG = "https://docs.google.com/spreadsheets/d/1IrWfGQDcHoOK7RQBQBi-Ob1gJTnZ4FNPnMndJZZBFfg/export?format=csv&gid=1358808453";

        // =================================================================

        // Estado Global
        let currentDate = new Date();
        let metasData = [];
        let logData = [];
        
        // LOGIN LOGIC
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const err = document.getElementById('loginError');

            if (u === 'admin' && p === 'dg1234') {
                // Sucesso
                localStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                // Erro
                err.classList.remove('hidden');
                // Treme o form
                const form = document.querySelector('form');
                form.classList.add('animate-pulse');
                setTimeout(() => form.classList.remove('animate-pulse'), 500);
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            initDashboard();
        }

        // Inicializa√ß√£o
        window.onload = function() {
            const isLogged = localStorage.getItem('isLoggedIn');
            if (isLogged === 'true') {
                showDashboard();
            }
            // Caso contr√°rio, fica na tela de login
        };

        function initDashboard() {
            console.log("Dashboard Iniciado üöÄ");
            updateMonthDisplay();
            
            if(LINK_FIXO_METAS && LINK_FIXO_METAS.length > 10) {
                fetchData(LINK_FIXO_METAS, LINK_FIXO_LOG);
            } else {
                const sM = localStorage.getItem('urlMetas');
                const sL = localStorage.getItem('urlLog');
                if(sM && sL) {
                    document.getElementById('urlMetasInput').value = sM;
                    document.getElementById('urlLogInput').value = sL;
                    fetchData(sM, sL);
                } else {
                    openConfig();
                }
            }
        }

        // --- Fun√ß√µes do Dashboard (iguais V3) ---
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthDisplay();
            renderDashboard();
        }

        function updateMonthDisplay() {
            const options = { month: 'long', year: 'numeric' };
            const dateStr = new Intl.DateTimeFormat('pt-BR', options).format(currentDate);
            document.getElementById('currentMonthDisplay').innerText = dateStr;
        }

        function openConfig() { document.getElementById('configModal').classList.remove('hidden'); }
        function closeConfig() { document.getElementById('configModal').classList.add('hidden'); }
        
        function saveAndLoad() {
            const u1 = document.getElementById('urlMetasInput').value;
            const u2 = document.getElementById('urlLogInput').value;
            if(!u1 || !u2) return alert("Preencha os dois links.");
            localStorage.setItem('urlMetas', u1);
            localStorage.setItem('urlLog', u2);
            fetchData(u1, u2);
            closeConfig();
        }

        function fetchData(url1, url2) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            let loadedCount = 0;
            const checkDone = () => { loadedCount++; if(loadedCount === 2) { document.getElementById('loadingIndicator').classList.add('hidden'); renderDashboard(); } };

            Papa.parse(url1, { download: true, header: true, skipEmptyLines: true, complete: (res) => { metasData = res.data; checkDone(); }, error: (err) => { alert("Erro Metas: " + err); checkDone(); }});
            Papa.parse(url2, { download: true, header: true, skipEmptyLines: true, complete: (res) => { logData = res.data; checkDone(); }, error: (err) => { alert("Erro Log: " + err); checkDone(); }});
        }

        function renderDashboard() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if(!metasData.length) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            // Stats M√™s Atual
            const currentMonthStats = {};
            const targetMonth = currentDate.getMonth();
            const targetYear = currentDate.getFullYear();

            logData.forEach(row => {
                let dString = row['Data Cria√ß√£o'] || row['Data'] || "";
                let itemDate = new Date(dString);
                if(isNaN(itemDate.getTime()) && !isNaN(dString)) itemDate = new Date(parseInt(dString));

                if(!isNaN(itemDate.getTime())) {
                    if(itemDate.getMonth() === targetMonth && itemDate.getFullYear() === targetYear) {
                        const client = (row['Nome do Cliente'] || "").trim();
                        const type = (row['Tipo de Entrega'] || "").trim();
                        const qty = parseInt(row['Qtd']) || 1;

                        if(!currentMonthStats[client]) currentMonthStats[client] = { social: 0, perf: 0 };
                        if(type.toLowerCase().includes('social')) currentMonthStats[client].social += qty;
                        else if(type.toLowerCase().includes('performance')) currentMonthStats[client].perf += qty;
                    }
                }
            });

            // Cruzar e Renderizar
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let kpiTotal=0, kpiRisk=0, kpiSD=0, kpiSM=0, kpiPD=0, kpiPM=0, hasData=false;

            metasData.forEach(meta => {
                const client = (meta['Nome do Cliente'] || "").trim();
                if(!client) return;
                if(searchTerm && !client.toLowerCase().includes(searchTerm)) return;

                hasData = true; kpiTotal++;
                const mS = parseInt(meta['Meta Social Media']) || 0;
                const mP = parseInt(meta['Meta Performance']) || 0;
                const stats = currentMonthStats[client] || { social: 0, perf: 0 };
                const gapS = mS - stats.social;
                const gapP = mP - stats.perf;

                kpiSD += stats.social; kpiSM += mS; kpiPD += stats.perf; kpiPM += mP;
                const isRisk = (gapS > 0 && mS > 0) || (gapP > 0 && mP > 0);
                if(isRisk) kpiRisk++;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 group";
                
                tr.innerHTML = `
                    <td class="p-4 pl-6 sticky left-0 bg-white group-hover:bg-slate-50 z-20 font-medium text-slate-700 flex items-center gap-3 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-r border-slate-100">
                        <span class="w-2.5 h-2.5 rounded-full ${isRisk ? 'bg-red-500 animate-pulse' : 'bg-green-500'}"></span>
                        <span class="truncate max-w-[180px]" title="${client}">${client}</span>
                    </td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mS}</td>
                    <td class="p-2 text-center px-4">${renderBar(stats.social, mS, gapS)}</td>
                    <td class="p-2 text-center font-bold ${gapS>0 ? 'text-red-500' : 'text-emerald-500'}">${gapS > 0 ? '-' + gapS : '<i class="fa-solid fa-check"></i>'}</td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mP}</td>
                    <td class="p-2 text-center px-4">${renderBar(stats.perf, mP, gapP)}</td>
                    <td class="p-2 text-center font-bold ${gapP>0 ? 'text-red-500' : 'text-emerald-500'}">${gapP > 0 ? '-' + gapP : '<i class="fa-solid fa-check"></i>'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('kpiTotalClients').innerText = kpiTotal;
            document.getElementById('kpiRisk').innerText = kpiRisk;
            document.getElementById('kpiSocialDone').innerText = kpiSD; document.getElementById('kpiSocialMeta').innerText = kpiSM;
            document.getElementById('kpiPerfDone').innerText = kpiPD; document.getElementById('kpiPerfMeta').innerText = kpiPM;
            document.getElementById('emptyState').className = hasData ? 'hidden' : 'absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/80 z-0';
        }

        function renderBar(val, max, gap) {
            if(max === 0) return '<span class="text-xs text-slate-300">-</span>';
            const pct = Math.min((val / max) * 100, 100);
            const colorClass = gap > 0 ? 'bg-amber-400' : 'bg-emerald-500';
            return <div class="w-full flex flex-col items-center"><div class="w-full flex justify-between text-[10px] text-slate-400 mb-1 px-1"><span class="font-bold text-slate-600">${val}</span><span>${Math.round(pct)}%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${colorClass} transition-all duration-500 ease-out" style="width: ${pct}%"></div></div></div>;
        }
    </script>
</body>
</html>