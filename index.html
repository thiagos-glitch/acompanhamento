<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volumetria | Acesso Restrito</title>
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- √çcones -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PapaParse (Leitor de CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- =========================
         TELA DE LOGIN (SEM FORMUL√ÅRIO PARA EVITAR ERROS)
    ========================== -->
    <div id="loginScreen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 fade-in text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-50 text-indigo-600 text-2xl shadow-sm">
                <i class="fa-solid fa-lock"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Acesso Restrito</h2>
            <p class="text-sm text-slate-500 mb-6">Digite suas credenciais para visualizar.</p>
            
            <!-- Usamos DIV em vez de FORM para garantir que o Enter n√£o recarregue a p√°gina -->
            <div class="space-y-4 text-left" id="loginBox">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Usu√°rio</label>
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <!-- onkeydown detecta o Enter manualmente -->
                        <input type="text" id="username" onkeydown="handleEnter(event)" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="Usu√°rio">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Senha</label>
                    <div class="relative">
                        <i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="password" id="password" onkeydown="handleEnter(event)" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>

                <div id="loginError" class="hidden text-red-500 text-xs text-center font-medium bg-red-50 p-2 rounded-lg border border-red-100">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> Dados incorretos.
                </div>

                <!-- Bot√£o type="button" para n√£o submeter nada nativamente -->
                <button type="button" onclick="executeLogin()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition transform active:scale-95">
                    Entrar <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
            
            <p class="mt-6 text-xs text-slate-400">Digital Growth &copy; 2025</p>
        </div>
    </div>

    <!-- =========================
         CONTE√öDO DO DASHBOARD (Oculto at√© logar)
    ========================== -->
    <div id="appContent" class="hidden h-full flex flex-col">
        <!-- Navbar -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-20 shadow-sm flex-shrink-0">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-md shadow-indigo-200">
                        <i class="fa-solid fa-layer-group"></i>
                    </span>
                    Volumetria
                </h1>
                
                <!-- Seletor de M√™s -->
                <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition cursor-pointer">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span id="currentMonthDisplay" class="w-36 text-center font-semibold text-sm text-slate-700 select-none uppercase tracking-wide">
                        ...
                    </span>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition cursor-pointer">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="relative w-64 group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition"></i>
                    <input type="text" id="searchInput" onkeyup="renderDashboard()" placeholder="Filtrar cliente..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition">
                </div>
                
                <button onclick="openConfig()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium rounded-lg transition shadow-sm" title="Configurar Links">
                    <i class="fa-solid fa-gear"></i>
                </button>
                
                <!-- Bot√£o de Sair -->
                <button onclick="logout()" class="p-2 text-slate-400 hover:text-red-500 transition" title="Sair do Sistema">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>

                <div id="loadingIndicator" class="hidden">
                    <div class="loader"></div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 flex flex-col overflow-hidden p-6 gap-6">
            <!-- KPIs Row -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 flex-shrink-0">
                <!-- Social -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entregas Social</p>
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-slate-800" id="kpiSocialDone">0</h3>
                            <span class="text-sm text-slate-400 font-medium">/ <span id="kpiSocialMeta">0</span></span>
                        </div>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="fa-brands fa-instagram"></i></div>
                </div>

                <!-- Perf -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Entregas Perf.</p>
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-slate-800" id="kpiPerfDone">0</h3>
                            <span class="text-sm text-slate-400 font-medium">/ <span id="kpiPerfMeta">0</span></span>
                        </div>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-purple-50 text-purple-600 flex items-center justify-center text-xl"><i class="fa-solid fa-chart-line"></i></div>
                </div>

                <!-- Risk -->
                <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between border-l-4 border-l-red-500 hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Clientes Cr√≠ticos</p>
                        <h3 class="text-3xl font-bold text-red-600" id="kpiRisk">0</h3>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-xl"><i class="fa-solid fa-triangle-exclamation"></i></div>
                </div>

                 <!-- Total -->
                 <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Clientes</p>
                        <h3 class="text-3xl font-bold text-slate-800" id="kpiTotalClients">0</h3>
                    </div>
                    <div class="h-10 w-10 rounded-lg bg-slate-50 text-slate-600 flex items-center justify-center text-xl"><i class="fa-solid fa-users"></i></div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 overflow-hidden flex flex-col relative">
                <div class="overflow-auto custom-scroll flex-1">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                            <tr>
                                <th class="p-4 pl-6 bg-slate-50 sticky left-0 z-20 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-wider shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">Cliente</th>
                                <th class="p-2 border-b border-slate-200 text-center bg-blue-50/50 border-l border-slate-200" colspan="3"><span class="text-blue-700 font-bold text-xs"><i class="fa-brands fa-instagram mr-1"></i> Social Media</span></th>
                                <th class="p-2 border-b border-slate-200 text-center bg-purple-50/50 border-l border-slate-200" colspan="3"><span class="text-purple-700 font-bold text-xs"><i class="fa-solid fa-chart-line mr-1"></i> Performance</span></th>
                            </tr>
                            <tr class="text-[10px] uppercase text-slate-400 font-bold border-b border-slate-200 bg-slate-50">
                                <th class="sticky left-0 bg-slate-50 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]"></th>
                                <!-- Social -->
                                <th class="p-2 text-center w-20 border-l border-slate-100">Meta</th>
                                <th class="p-2 text-center w-32">Realizado</th>
                                <th class="p-2 text-center w-16">Gap</th>
                                <!-- Perf -->
                                <th class="p-2 text-center w-20 border-l border-slate-100">Meta</th>
                                <th class="p-2 text-center w-32">Realizado</th>
                                <th class="p-2 text-center w-16">Gap</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/80 z-0">
                    <div class="bg-slate-50 p-6 rounded-full mb-4">
                        <i class="fa-solid fa-database text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-lg font-medium text-slate-600">Sem dados para exibir</h3>
                    <p class="text-sm">Verifique a conex√£o ou mude o m√™s.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-800">Conectar Base de Dados</h3>
                <button onclick="closeConfig()" class="text-slate-400 hover:text-slate-600 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Link CSV de Cadastros (Metas)</label>
                    <input type="text" id="urlMetasInput" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Link CSV de Hist√≥rico (Log)</label>
                    <input type="text" id="urlLogInput" class="w-full px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button onclick="closeConfig()" class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">Cancelar</button>
                <button onclick="saveAndLoad()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-lg shadow-lg transition">Salvar</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // =================================================================
        // √ÅREA DE CONFIGURA√á√ÉO FIXA
        // =================================================================
        
        // COLE SEUS LINKS AQUI (dentro das aspas) PARA SALVAR!
        const LINK_FIXO_METAS = "https://docs.google.com/spreadsheets/d/1IrWfGQDcHoOK7RQBQBi-Ob1gJTnZ4FNPnMndJZZBFfg/export?format=csv&gid=0";
        const LINK_FIXO_LOG = "https://docs.google.com/spreadsheets/d/1IrWfGQDcHoOK7RQBQBi-Ob1gJTnZ4FNPnMndJZZBFfg/export?format=csv&gid=1358808453";

        // =================================================================

        // Estado Global
        let currentDate = new Date();
        let metasData = [];
        let logData = [];
        
        // --- SISTEMA DE LOGIN MANUAL (SEM FORM) ---
        
        // Detectar ENTER nos campos
        function handleEnter(e) {
            if (e.key === 'Enter') {
                executeLogin();
            }
        }

        // Login Direto
        function executeLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const err = document.getElementById('loginError');

            // --- CREDENCIAIS NOVAS AQUI ---
            if (u === 'dg' && p === 'dg123') {
                localStorage.setItem('isLoggedIn', 'true');
                showDashboard();
            } else {
                err.classList.remove('hidden');
                const box = document.getElementById('loginBox');
                box.classList.add('animate-pulse');
                setTimeout(() => box.classList.remove('animate-pulse'), 500);
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            initDashboard();
        }

        // Inicializa√ß√£o
        window.onload = function() {
            const isLogged = localStorage.getItem('isLoggedIn');
            if (isLogged === 'true') {
                showDashboard();
            }
            // Caso contr√°rio, fica no login
        };

        // --- DASHBOARD LOGIC ---
        function initDashboard() {
            console.log("Dashboard Iniciado üöÄ");
            updateMonthDisplay();
            
            if(LINK_FIXO_METAS.length > 10) {
                fetchData(LINK_FIXO_METAS, LINK_FIXO_LOG);
            } else {
                const sM = localStorage.getItem('urlMetas'), sL = localStorage.getItem('urlLog');
                if(sM && sL) {
                    document.getElementById('urlMetasInput').value = sM;
                    document.getElementById('urlLogInput').value = sL;
                    fetchData(sM, sL);
                } else {
                    openConfig();
                }
            }
        }

        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); updateMonthDisplay(); renderDashboard(); }
        function updateMonthDisplay() { document.getElementById('currentMonthDisplay').innerText = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' }).format(currentDate); }
        function openConfig() { document.getElementById('configModal').classList.remove('hidden'); }
        function closeConfig() { document.getElementById('configModal').classList.add('hidden'); }
        
        function saveAndLoad() {
            const u1 = document.getElementById('urlMetasInput').value;
            const u2 = document.getElementById('urlLogInput').value;
            if(!u1 || !u2) return alert("Preencha links.");
            localStorage.setItem('urlMetas', u1); localStorage.setItem('urlLog', u2);
            fetchData(u1, u2); closeConfig();
        }

        function fetchData(url1, url2) {
            document.getElementById('loadingIndicator').classList.remove('hidden');
            let loadedCount = 0;
            const checkDone = () => { loadedCount++; if(loadedCount === 2) { document.getElementById('loadingIndicator').classList.add('hidden'); renderDashboard(); } };
            Papa.parse(url1, { download: true, header: true, skipEmptyLines: true, complete: (res) => { metasData = res.data; checkDone(); }, error: (err) => { alert("Erro: " + err); checkDone(); }});
            Papa.parse(url2, { download: true, header: true, skipEmptyLines: true, complete: (res) => { logData = res.data; checkDone(); }, error: (err) => { alert("Erro: " + err); checkDone(); }});
        }

        function renderDashboard() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            if(!metasData.length) { document.getElementById('emptyState').classList.remove('hidden'); return; }

            const currentMonthStats = {};
            const tM = currentDate.getMonth(), tY = currentDate.getFullYear();

            logData.forEach(row => {
                let dStr = row['Data Cria√ß√£o'] || row['Data'] || "", iDate = new Date(dStr);
                if(isNaN(iDate.getTime()) && !isNaN(dStr)) iDate = new Date(parseInt(dStr));
                if(!isNaN(iDate.getTime()) && iDate.getMonth()===tM && iDate.getFullYear()===tY) {
                    const c = (row['Nome do Cliente']||"").trim(), t = (row['Tipo de Entrega']||"").trim(), q = parseInt(row['Qtd'])||1;
                    if(!currentMonthStats[c]) currentMonthStats[c] = { social: 0, perf: 0 };
                    if(t.toLowerCase().includes('social')) currentMonthStats[c].social += q;
                    else if(t.toLowerCase().includes('performance')) currentMonthStats[c].perf += q;
                }
            });

            const search = document.getElementById('searchInput').value.toLowerCase();
            let kT=0, kR=0, kSD=0, kSM=0, kPD=0, kPM=0, hasData=false;

            metasData.forEach(meta => {
                const c = (meta['Nome do Cliente']||"").trim();
                if(!c || (search && !c.toLowerCase().includes(search))) return;
                hasData = true; kT++;
                const mS = parseInt(meta['Meta Social Media'])||0, mP = parseInt(meta['Meta Performance'])||0;
                const st = currentMonthStats[c] || { social: 0, perf: 0 };
                const gS = mS - st.social, gP = mP - st.perf;
                kSD+=st.social; kSM+=mS; kPD+=st.perf; kPM+=mP;
                if((gS>0 && mS>0) || (gP>0 && mP>0)) kR++;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 group";
                tr.innerHTML = `
                    <td class="p-4 pl-6 sticky left-0 bg-white group-hover:bg-slate-50 z-20 font-medium text-slate-700 flex items-center gap-3 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] border-r border-slate-100">
                        <span class="w-2.5 h-2.5 rounded-full ${((gS>0 && mS>0) || (gP>0 && mP>0)) ? 'bg-red-500 animate-pulse' : 'bg-green-500'}"></span>
                        <span class="truncate max-w-[180px]" title="${c}">${c}</span>
                    </td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mS}</td>
                    <td class="p-2 text-center px-4">${renderBar(st.social, mS, gS)}</td>
                    <td class="p-2 text-center font-bold ${gS>0?'text-red-500':'text-emerald-500'}">${gS>0?'-'+gS:'<i class="fa-solid fa-check"></i>'}</td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mP}</td>
                    <td class="p-2 text-center px-4">${renderBar(st.perf, mP, gP)}</td>
                    <td class="p-2 text-center font-bold ${gP>0?'text-red-500':'text-emerald-500'}">${gP>0?'-'+gP:'<i class="fa-solid fa-check"></i>'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('kpiTotalClients').innerText = kT; document.getElementById('kpiRisk').innerText = kR;
            document.getElementById('kpiSocialDone').innerText = kSD; document.getElementById('kpiSocialMeta').innerText = kSM;
            document.getElementById('kpiPerfDone').innerText = kPD; document.getElementById('kpiPerfMeta').innerText = kPM;
            document.getElementById('emptyState').className = hasData ? 'hidden' : 'absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/80 z-0';
        }

        function renderBar(val, max, gap) {
            if(max===0) return '<span class="text-xs text-slate-300">-</span>';
            const pct = Math.min((val/max)*100, 100);
            return <div class="w-full flex flex-col items-center"><div class="w-full flex justify-between text-[10px] text-slate-400 mb-1 px-1"><span class="font-bold text-slate-600">${val}</span><span>${Math.round(pct)}%</span></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${gap>0?'bg-amber-400':'bg-emerald-500'} transition-all duration-500" style="width: ${pct}%"></div></div></div>;
        }
    </script>
</body>
</html>