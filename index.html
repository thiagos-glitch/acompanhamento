<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Volumetria - Definitivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/plugin/customParseFormat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-20 shadow-sm flex-shrink-0">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i class="fa-solid fa-layer-group"></i></span>
                Volumetria
            </h1>
            
            <div class="flex items-center bg-slate-100 rounded-lg p-1 border border-slate-200">
                <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="currentMonthDisplay" class="w-32 text-center font-semibold text-sm text-slate-700 select-none">...</span>
                <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 rounded-md transition"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="relative w-64">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" onkeyup="renderDashboard()" placeholder="Filtrar cliente..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>
            <button onclick="openConfig()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 text-sm font-medium rounded-lg transition shadow-sm" title="Alterar Links">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col overflow-hidden p-6 gap-6">
        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 flex-shrink-0">
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Entregas Social</p><div class="flex items-baseline gap-2"><h3 class="text-2xl font-bold text-slate-800" id="kpiSocialDone">0</h3><span class="text-sm text-slate-400">/ <span id="kpiSocialMeta">0</span></span></div></div>
                <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-lg"><i class="fa-brands fa-instagram"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Entregas Perf.</p><div class="flex items-baseline gap-2"><h3 class="text-2xl font-bold text-slate-800" id="kpiPerfDone">0</h3><span class="text-sm text-slate-400">/ <span id="kpiPerfMeta">0</span></span></div></div>
                <div class="h-10 w-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-lg"><i class="fa-solid fa-chart-line"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between border-l-4 border-l-red-500">
                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Clientes Críticos</p><h3 class="text-2xl font-bold text-red-600" id="kpiRisk">0</h3></div>
                <div class="h-10 w-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center text-lg"><i class="fa-solid fa-triangle-exclamation"></i></div>
            </div>
             <div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between">
                <div><p class="text-xs font-bold text-slate-400 uppercase mb-1">Total Clientes</p><h3 class="text-2xl font-bold text-slate-800" id="kpiTotalClients">0</h3></div>
                <div class="h-10 w-10 rounded-full bg-slate-50 text-slate-600 flex items-center justify-center text-lg"><i class="fa-solid fa-users"></i></div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex-1 overflow-hidden flex flex-col">
            <div class="overflow-auto custom-scroll flex-1">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                        <tr>
                            <th class="p-4 pl-6 bg-slate-50 sticky left-0 z-20 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-wider shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Cliente</th>
                            <th class="p-2 border-b border-slate-200 text-center bg-blue-50/50 border-l" colspan="3"><span class="text-blue-600 font-bold"><i class="fa-brands fa-instagram"></i> Social Media</span></th>
                            <th class="p-2 border-b border-slate-200 text-center bg-purple-50/50 border-l" colspan="3"><span class="text-purple-600 font-bold"><i class="fa-solid fa-chart-line"></i> Performance</span></th>
                        </tr>
                        <tr class="text-[10px] uppercase text-slate-400 font-bold border-b border-slate-200 bg-slate-50">
                            <th class="sticky left-0 bg-slate-50 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]"></th>
                            <th class="p-2 text-center w-20 border-l">Meta</th><th class="p-2 text-center w-32">Realizado</th><th class="p-2 text-center w-16">Gap</th>
                            <th class="p-2 text-center w-20 border-l">Meta</th><th class="p-2 text-center w-32">Realizado</th><th class="p-2 text-center w-16">Gap</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm divide-y divide-slate-100"></tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden h-full flex flex-col items-center justify-center text-slate-400">
                <i class="fa-solid fa-ghost text-4xl mb-3 opacity-50"></i><p>Nenhum dado encontrado.</p>
            </div>
        </div>
    </main>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-fade-in-up">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">Configurar Links</h3>
            <p class="text-sm text-slate-500 mb-4">Para não pedir mais, edite este arquivo HTML e cole os links nas variáveis <code>LINK_FIXO</code> lá no final.</p>
            <input type="text" id="urlMetas" placeholder="Link CSV Metas" class="w-full mb-3 px-3 py-2 border rounded-lg text-sm">
            <input type="text" id="urlLog" placeholder="Link CSV Log" class="w-full mb-3 px-3 py-2 border rounded-lg text-sm">
            <div class="flex justify-end gap-3"><button onclick="closeConfig()" class="px-4 py-2 text-sm">Fechar</button><button onclick="saveAndLoad()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm">Salvar</button></div>
        </div>
    </div>

    <script>
        // =================================================================
        // ÁREA DE CONFIGURAÇÃO FIXA - COLE SEUS LINKS AQUI PARA SALVAR!
        // =================================================================
        
        const LINK_FIXO_METAS = "";  // <-- Cole o Link 1 (BD_Metas CSV) dentro das aspas
        const LINK_FIXO_LOG = "";    // <-- Cole o Link 2 (Log_Robo CSV) dentro das aspas

        // =================================================================

        dayjs.extend(window.dayjs_plugin_customParseFormat);
        let currentDate = dayjs();
        let metasData = [], logData = [];

        window.onload = function() {
            updateMonthDisplay();
            
            // 1. Prioridade: Links Fixos no código
            if(LINK_FIXO_METAS && LINK_FIXO_METAS.length > 10 && LINK_FIXO_LOG && LINK_FIXO_LOG.length > 10) {
                fetchData(LINK_FIXO_METAS, LINK_FIXO_LOG);
                return; 
            }

            // 2. Tenta localStorage
            const storedMetas = localStorage.getItem('urlMetas');
            const storedLog = localStorage.getItem('urlLog');
            if(storedMetas && storedLog) {
                document.getElementById('urlMetas').value = storedMetas;
                document.getElementById('urlLog').value = storedLog;
                fetchData(storedMetas, storedLog);
            } else {
                openConfig(); // Se não tem nada, abre o modal
            }
        };

        function changeMonth(delta) { currentDate = currentDate.add(delta, 'month'); updateMonthDisplay(); renderDashboard(); }
        function updateMonthDisplay() {
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('currentMonthDisplay').innerText = ${months[currentDate.month()]} ${currentDate.year()};
        }
        function openConfig() { document.getElementById('configModal').classList.remove('hidden'); }
        function closeConfig() { document.getElementById('configModal').classList.add('hidden'); }
        
        function saveAndLoad() {
            const u1 = document.getElementById('urlMetas').value;
            const u2 = document.getElementById('urlLog').value;
            if(!u1 || !u2) return alert("Preencha os dois links.");
            localStorage.setItem('urlMetas', u1);
            localStorage.setItem('urlLog', u2);
            fetchData(u1, u2);
            closeConfig();
        }

        function fetchData(url1, url2) {
            let loadedCount = 0;
            Papa.parse(url1, { download: true, header: true, complete: (res) => { metasData = res.data; loadedCount++; if(loadedCount===2) renderDashboard(); }});
            Papa.parse(url2, { download: true, header: true, complete: (res) => { logData = res.data; loadedCount++; if(loadedCount===2) renderDashboard(); }});
        }

        function renderDashboard() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            if(!metasData.length) return;

            const currentMonthStats = {};
            logData.forEach(row => {
                let d = dayjs(row['Data Criação']);
                if(!d.isValid()) d = dayjs(parseInt(row['Data Criação'])); 
                if(d.isSame(currentDate, 'month')) {
                    const client = row['Nome do Cliente'];
                    const type = row['Tipo de Entrega'];
                    const qty = parseInt(row['Qtd']) || 1;
                    if(!currentMonthStats[client]) currentMonthStats[client] = { social: 0, perf: 0 };
                    if(type === 'Social Media') currentMonthStats[client].social += qty;
                    if(type === 'Performance') currentMonthStats[client].perf += qty;
                }
            });

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let kpiTotal=0, kpiRisk=0, kpiSD=0, kpiSM=0, kpiPD=0, kpiPM=0, hasData=false;

            metasData.forEach(meta => {
                const client = meta['Nome do Cliente'];
                if(!client || !client.trim()) return;
                if(searchTerm && !client.toLowerCase().includes(searchTerm)) return;

                kpiTotal++; hasData = true;
                const mS = parseInt(meta['Meta Social Media']) || 0;
                const mP = parseInt(meta['Meta Performance']) || 0;
                const stats = currentMonthStats[client] || { social: 0, perf: 0 };
                const gapS = mS - stats.social;
                const gapP = mP - stats.perf;

                kpiSD += stats.social; kpiSM += mS; kpiPD += stats.perf; kpiPM += mP;
                if(gapS > 0 || gapP > 0) kpiRisk++;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 group";
                const isCrit = gapS > 0 || gapP > 0;
                tr.innerHTML = `
                    <td class="p-4 pl-6 sticky left-0 bg-white group-hover:bg-slate-50 z-20 font-medium text-slate-700 flex items-center gap-3 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                        <span class="w-2 h-2 rounded-full ${isCrit ? 'bg-red-500' : 'bg-green-500'}"></span>
                        <span class="truncate max-w-[150px]" title="${client}">${client}</span>
                    </td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mS}</td>
                    <td class="p-2 text-center">${renderBar(stats.social, mS, gapS)}</td>
                    <td class="p-2 text-center font-bold ${gapS>0?'text-red-500':'text-slate-300'}">${gapS>0?'-'+gapS:'<i class="fa-solid fa-check text-green-500"></i>'}</td>
                    <td class="p-2 text-center text-slate-400 text-xs border-l border-slate-100 font-mono">${mP}</td>
                    <td class="p-2 text-center">${renderBar(stats.perf, mP, gapP)}</td>
                    <td class="p-2 text-center font-bold ${gapP>0?'text-red-500':'text-slate-300'}">${gapP>0?'-'+gapP:'<i class="fa-solid fa-check text-green-500"></i>'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('kpiTotalClients').innerText = kpiTotal;
            document.getElementById('kpiRisk').innerText = kpiRisk;
            document.getElementById('kpiSocialDone').innerText = kpiSD; document.getElementById('kpiSocialMeta').innerText = kpiSM;
            document.getElementById('kpiPerfDone').innerText = kpiPD; document.getElementById('kpiPerfMeta').innerText = kpiPM;
            document.getElementById('emptyState').className = hasData ? 'hidden' : 'h-full flex flex-col items-center justify-center text-slate-400';
        }

        function renderBar(val, max, gap) {
            if(max===0) return '<span class="text-xs text-slate-300">-</span>';
            const pct = Math.min((val/max)*100, 100);
            return <div class="w-full flex flex-col items-center"><span class="text-xs font-bold text-slate-600">${val}</span><div class="w-24 h-1.5 bg-slate-100 rounded-full overflow-hidden mt-1"><div class="h-full ${gap>0?'bg-yellow-400':'bg-green-500'}" style="width: ${pct}%"></div></div></div>;
        }
    </script>
</body>
</html>